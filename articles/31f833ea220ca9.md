---
title: "é‡ç®±ã®éš…ã‚’ã¤ã¤ãã‚¯ãƒ©ã‚¹ã®ã‚ã‚Œã“ã‚Œ"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Python", "Class", "ã‚¯ãƒ©ã‚¹"]
published: true
---

## ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã¯ç­†è€…ãŒPythonã®å­¦ç¿’ã‚’ã™ã‚‹ã†ãˆã§å¾—ãŸçŸ¥è­˜ã®å‚™å¿˜éŒ²ã§ã™ã€‚æ˜ç¤ºçš„ã«ã‚‚æš—é»™çš„ã«ã‚‚å…¨ã¦ãŒæ­£ã—ã„ã¨ã¯ä¿è¨¼ã§ããªã„ã®ã§ã”å®¹èµ¦ãã ã•ã„ï¼ˆé–“é•ã„ã®æŒ‡æ‘˜ã¯å¤§æ­“è¿ã§ã™ï¼‰ã€‚ä»Šå›ã¯ã‚¯ãƒ©ã‚¹ã¨ãã®å‘¨ã‚Šã«ã¤ã„ã¦è§¦ã‚Œã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã®åŸºç¤ã¯åˆ†ã‹ã£ã¦ã„ã‚‹å‰æã§ã€çŸ¥ã£ã¦ã„ã‚‹ã¨å°‘ã—ãŠå¾—ã‹ã‚‚ã£ã¦ç¨‹åº¦ã®å†…å®¹ã§ã™ã€‚

## åŸºæœ¬çš„ãªç‰¹æ®Šãƒ¡ã‚½ãƒƒãƒ‰

è‡ªåˆ†ã®å®šç¾©ã—ãŸã‚¯ãƒ©ã‚¹ã«è¶³ã—ç®—ã‚„å¼•ãç®—ç­‰ã‚’å®šç¾©ã§ãã¾ã™ã€‚ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢äºŒã¤ã§åå‰ãŒå›²ã¾ã‚Œã¦ã„ã¾ã™`(ex: __add__, __sub__, ...)`ã€‚ä»¥ä¸‹ã¯è¤‡ç´ æ•°ã‚’ç°¡æ˜“çš„ã«å®Ÿè£…ã—ãŸã‚‚ã®ã§ã™ã€‚å®Ÿéƒ¨ã¨è™šéƒ¨ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã«æŒã¡ã¾ã™ã€‚

```python
from typing import Union, TYPE_CHECKING

class Complex:

    __slots__ = (
        "real",
        "img"
    )

    if TYPE_CHECKING:
        real: Union[int, float]
        img: Union[int, float]

    def __init__(
        self,
        real: Union[int, float],
        img: Union[int, float, None] = 0
    ) -> None:
        self.real = real
        self.img = img


    def __add__(self, other: Union[int, float, Complex]) -> Complex:
        """è¶³ã—ç®—ã‚’å®šç¾©ã€€(self + otherã®ã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹)"""
        if isinstance(other, (int, float))
            real = other
            img = 0
        else:
            real = other.real
            img = other.img

        return Complex(self.real + real, self.img + img)

```

ä½•æ°—ãªãä½¿ã£ã¦ã„ãŸåŠ ç®—æ¼”ç®—å­ã§ã™ãŒã€`x + y`ã¨ã„ã†ã®ã¯`type(x).__add__(x, y)`ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã ã£ãŸã¨ã„ã†ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ãã®ä»–ã«ã‚¤ã‚³ãƒ¼ãƒ«ã‚„çµ¶å¯¾å€¤ã€`str`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ãŸã¨ãã«æŒ™å‹•ã‚‚å®šç¾©ã§ãã¾ã™ã€‚

:::message
`__slots__`ã¨ã„ã†ã®ã¯ã€å®šç¾©ã™ã‚‹ã¨æŒ‡å®šã—ãŸå±æ€§ä»¥å¤–ã‚’å®šç¾©ãŒã§ããªããªã‚Šã¾ã™ã€‚ãã®ä»£ã‚ã‚Šã«å°‘ã—ã°ã‹ã‚Šã§ã™ãŒãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ãŒæ¸›ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹ãŒé€Ÿããªã‚Šã¾ã™ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‹ã‚’è¦‹ã‚‹ã¨ã‚¯ãƒ©ã‚¹å†…ã§äº‹å‰ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚‚æ•£è¦‹ã•ã‚Œã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’èª­ã¾ãªãã¦ã‚‚å­˜åœ¨ã—å¾—ã‚‹å±æ€§ãŒé™å®šã•ã‚Œã¦ã„ã‚‹ã®ã¯å¬‰ã—ã„ã§ã™ã­ã€‚ãŸã ã€å‹•çš„ã«å±æ€§ã‚’è¿½åŠ ã§ããªã„ã®ã§å®Ÿè£…ã‚³ã‚¹ãƒˆã¯è‹¥å¹²ä¸ŠãŒã‚Šã¾ã™ã€‚
:::

```python
import math

...

    def __eq__(self, other) -> bool:
        """x == y ã®å®šç¾©"""
        return (
            isinstance(other, Complex)
            and self.real == other.real
            and self.img == other.img
        )

    def __abs__(self) -> float:
        """abs(x)ãŒå‘¼ã°ã‚ŒãŸã¨ãã®æŒ™å‹•"""
        return math.sqrt(self.real**2 + self.img**2)

    def __str__(self) -> str:
        """str(x)ãŒå‘¼ã°ã‚ŒãŸæ™‚ã®æŒ™å‹•""""
        return "{}{+:}*j".format(self.real, self.img)

```

:::message
å¸¸è­˜ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€`__eq__`ã®æ¯”è¼ƒå†…ã§`isinstance`ã‚’å…ˆã«ãŠã„ã¦ã‚¿ã‚¤ãƒ—ã‚¬ãƒ¼ãƒ‰çš„ãªã“ã¨ãŒã§ãã¦ä¾¿åˆ©ã§ã™ã€‚Pythonã®ä»•æ§˜ã§`and`ã§çµã°ã‚ŒãŸè«–ç†å¼ã§`False`ãŒç™ºç”Ÿã™ã‚‹ã¨ã€ãã‚Œä»¥é™ã¯å‚ç…§ã•ã‚Œãšå³åº§ã«`False`ãŒæ¸¡ã•ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚
:::

### å¿œç”¨

ç‰¹æ®Šãƒ¡ã‚½ãƒƒãƒ‰ã¯ä½¿ã†ã¨çµæ§‹ä¾¿åˆ©ãªã®ã¯è¨€ã†ã¾ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã¨åˆã‚ã›ã‚‹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã‹å®Ÿè£…ã§ãã¦é¢ç™½ã„ã§ã™ã€‚ã‚ã–ã‚ã–è‡ªåˆ†ã§å®Ÿè£…ã™ã‚‹æ©Ÿä¼šã¯å¤šãã¯ãªã„ã¨æ€ã„ã¾ã™ãŒã€ã‚ãã¾ã§ä½™è«‡ã§ã™ã€‚

`__get__`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ç‰¹æ®Šãƒ¡ã‚½ãƒƒãƒ‰ã®ãªã‹ã§ã‚‚ã‹ãªã‚Šä½ç´šã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚ªãƒ¼ãƒŠãƒ¼ã‚¯ãƒ©ã‚¹ or ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¯ãƒ©ã‚¹ã®å±æ€§ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«å‘¼ã°ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚ä»¥ä¸‹ã¯ãŠé¦´æŸ“ã¿`property`ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ãŸã‚‚ã®ã§ã™ã€‚`setter`ã‚„`getter`ç­‰ã¯å‰²æ„›ã—ã¾ã™ã€‚

```python
from __future__ import annotations
from typing import (
    Any,
    Callable,
    TypeVar,
    Generic,
    overload,
    Type,
    Optional
)

T = TypeVar('T')
T_co = TypeVar('T_co', covariant=True)

class _property(Generic[T, T_co]):

    def __init__(self, func: Callable[[T], T_co]) -> None:
        self.func = func

    @overload
    def __get__(self, instance: T, owner = Type[T]) -> T_co:
        ...
    @overload
    def __get__(self, instance: None, owner = Type[T]) -> _property[T, T_co]:
        ...
    def __get__(self, instance: Optional[T], owner: Type[T]) -> Any:
        if instance is None:
            return self
        return self.func(instance)

class Sample:

    def __init__(self, name) -> None:
        self._name = name

    @_property
    def name(self) -> str:
        return self._name

s = Sample('sample')
print(s.name) # sample
print(type(Sample.name)) # <class '__main__._property'>
```

:::message
`overload`ã¯å¼•æ•°ã®å‹ã«ã‚ˆã£ã¦è¿”ã™å€¤ã®å‹ãŒç•°ãªã‚‹å ´åˆã‚’æ˜ç¤ºã™ã‚‹ã¨ãã«ä½¿ã„ã¾ã™ã€‚`@overload`ã¯å¼•æ•°ã¨æˆ»ã‚Šå€¤ã®å‹ã‚’æ›¸ã‘ã°OKã§ã™ãŒã€ç›´å¾Œã«ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãªã—ã§å‡¦ç†ã‚’ã¡ã‚ƒã‚“ã¨æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
:::

é–‹ç™ºã—ã‚„ã™ã„ã‚ˆã†ã«å‹ãƒ’ãƒ³ãƒˆã‚’ã”ã¡ã‚ƒã”ã¡ã‚ƒæ›¸ã„ã¦ã„ã¾ã™ãŒã€ç´°ã‹ã„ã“ã¨ã¯æ°—ã«ã—ãªã„ã§çµæ§‹ã§ã™ã€‚é‡è¦ãªã®ã¯

```python
    def __get__(self, instance: Optional[T], owner: Type[T]) -> Any:
        if instance is None:
            return self
        return self.func(instance)
```

ã®éƒ¨åˆ†ã§ã™ã€‚`property`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã§å®šç¾©ã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ãŒ`self`ã®ã¿ãªã®ã¯ã€`property`ãŒå‘¼ã°ã‚ŒãŸã¨ãã«äºˆã‚ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä»˜ã‘ã‚‰ã‚ŒãŸé–¢æ•°ã®å¼•æ•°ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã‚’æ¸¡ã—ã¦ã„ã‚‹ã‹ã‚‰ã ã¨ã„ã†ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’å°‘ã—ã„ã˜ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å®Ÿè£…ã‚‚ã§ãã¾ã™ã€‚è¦ã¯åˆå›ã¯é–¢æ•°ã®å‡¦ç†ã‚’ã—ã¦çµæœã‚’ä¿å­˜ã—ã€äºŒåº¦ç›®ä»¥é™ã¯ä¿å­˜ã—ãŸå€¤ã‚’è¿”ã›ã°OKãªã®ã§ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

```python
class CachedProperty(Generic[T, T_co]):

    def __init__(self, func: Callable[[T], T_co]) -> None:
        self.func = func

    @overload
    def __get__(self, instance: T, owner = Type[T]) -> T_co:
        ...
    @overload
    def __get__(self, instance = None, owner = Type[T]) -> CachedProperty[T, T_co]:
        ...
    def __get__(self, instance: Optional[T], owner: Type[T]) -> Any:
        if instance is None:
            return self
        value = self.func(instance)
        print('called')
        setattr(instance, self.func.__name__, value)
        return value


class Sample2:

    def __init__(self) -> None:
        pass

    @CachedProperty
    def test(self) -> list[int]:
        return list(range(5000000))

if __name__ == '__main__':
    import time
    s = Sample2()
    start = time.time()
    s.test
    print(time.time() - start)
    start2 = time.time()
    s.test
    print(time.time() - start2)
```

ä»¥ä¸‹ã¯å®Ÿè¡Œçµæœä¾‹ã§ã™ã€‚åˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«é€”ä¸­ã§`print`ã‚’ã¯ã•ã‚“ã§ã„ã¾ã™ã€‚

```bash
called
0.06731486320495605
0.0
```

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã‚ãªã„å ´åˆã¨æ¯”è¼ƒã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```python
class Sample2:

    def __init__(self) -> None:
        pass

    def test(self) -> list[int]:
        return list(range(5000000))

if __name__ == '__main__':
    import time
    s = Sample2()
    start = time.time()
    s.test()
    print(time.time() - start)
    start2 = time.time()
    s.test()
    print(time.time() - start2)
```

çµæœ

```bash
0.10685992240905762
0.10961365699768066
```

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã£ãŸæ–¹ãŒæ˜ã‚‰ã‹ã«é€Ÿã„ã§ã™ã­ã€‚ã¶ã£ã¡ã‚ƒã‘`functools`ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã®ã§è‡ªåˆ†ã§å®Ÿè£…ã™ã‚‹ã®ã¯ã“ã®ãã‚‰ã„ã—ã‹ã‚ã‚Šã¾ã›ã‚“ãŒç¬‘
